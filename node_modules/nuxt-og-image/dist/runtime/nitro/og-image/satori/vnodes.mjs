import { html as convertHtmlToSatori } from "satori-html";
import { fetchIsland } from "../../util/kit.mjs";
import { htmlDecodeQuotes } from "../../util/encoding.mjs";
import { applyInlineCss } from "./transforms/inlineCss.mjs";
import { applyEmojis } from "./transforms/emojis.mjs";
import { walkSatoriTree } from "./utils.mjs";
import unocss from "./plugins/unocss.mjs";
import emojis from "./plugins/emojis.mjs";
import classes from "./plugins/classes.mjs";
import imageSrc from "./plugins/imageSrc.mjs";
import flex from "./plugins/flex.mjs";
import encoding from "./plugins/encoding.mjs";
export async function createVNodes(ctx) {
  let html = ctx.options.html;
  if (!html) {
    const island = await fetchIsland(ctx.e, ctx.options.component, typeof ctx.options.props !== "undefined" ? ctx.options.props : ctx.options);
    island.html = htmlDecodeQuotes(island.html);
    await applyInlineCss(ctx, island);
    await applyEmojis(ctx, island);
    html = island.html;
  }
  const template = `<div style="position: relative; display: flex; margin: 0 auto; width: ${ctx.options.width}px; height: ${ctx.options.height}px; overflow: hidden;">${html}</div>`;
  const satoriTree = convertHtmlToSatori(template);
  walkSatoriTree(ctx, satoriTree, [
    emojis,
    classes,
    flex,
    encoding
  ]);
  await Promise.all(walkSatoriTree(ctx, satoriTree, [
    unocss,
    imageSrc
  ]));
  return satoriTree;
}
